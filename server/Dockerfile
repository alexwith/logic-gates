FROM nginx:latest
COPY nginx.conf /etc/nginx/conf.d/default.conf

FROM gradle:jdk17 AS BUILD
WORKDIR /usr/app/
COPY . .

ARG BASE_URI=https://logicgates.alexwith.com
ARG DATABASE_URL=jdbc:postgresql://185.207.105.209:5432/logic-gates
ARG DATABASE_USERNAME
ARG DATABASE_PASSWORD
ARG GITHUB_CLIENT_ID
ARG GITHUB_CLIENT_SECRET
ENV BASE_URI=${BASE_URI}
ENV DATABASE_URL=${DATABASE_URL}
ENV DATABASE_USERNAME=${DATABASE_USERNAME}
ENV DATABASE_PASSWORD=${DATABASE_PASSWORD}
ENV GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID}
ENV GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}

RUN gradle build

FROM openjdk:17-oracle
WORKDIR /usr/app/
COPY --from=BUILD /usr/app/ .

ARG BASE_URI=https://logicgates.alexwith.com
ARG DATABASE_URL=jdbc:postgresql://185.207.105.209:5432/logic-gates
ARG DATABASE_USERNAME
ARG DATABASE_PASSWORD
ARG GITHUB_CLIENT_ID
ARG GITHUB_CLIENT_SECRET
ENV BASE_URI=${BASE_URI}
ENV DATABASE_URL=${DATABASE_URL}
ENV DATABASE_USERNAME=${DATABASE_USERNAME}
ENV DATABASE_PASSWORD=${DATABASE_PASSWORD}
ENV GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID}
ENV GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}

ENTRYPOINT exec java -jar /usr/app/build/libs/logic-gates.jar
